{{{
from google.appengine.ext import webapp
from google.appengine.ext.webapp.util import run_wsgi_app

import scribd


class Form(webapp.RequestHandler):
    """Creates the main page displaying documents and allowing to upload new ones."""
    
    def get(self):
        out = []
        
        # Start the document.
        out.append('<html><body>')

        # Start the table.
        out.append('<table border="3">')

        # Add the table header.
        out.append("""<tr>
                        <td>Status</td>
                        <td>Thumbnail</td>
                        <td>Title</td>
                        <td>Description</td>
                      </tr>""")
        
        # List all API user documents.
        for doc in scribd.api_user.xall():
            # Substitution dictionary.
            args = {'status': doc.conversion_status,
                    'thumbnail': doc.thumbnail_url,
                    'link': doc.get_scribd_url(),
                    'title': doc.title,
                    'description': doc.description}
            # Add table row.
            out.append("""<tr>
                            <td>%(status)s</td>
                            <td><a href="%(link)s"><img src="%(thumbnail)s" border="0"></a></td>
                            <td><a href="%(link)s">%(title)s</a></td>
                            <td><pre>%(description)s</pre></td>
                          </tr>""" % args)

        # End the table.        
        out.append('</table>')
        
        # Add file form for uploading.
        out.append("""<form method="post" enctype="multipart/form-data" action="/upload">
                        <input type="file" name="file" />
                        <input type="submit" />
                      </form>""")

        # End the document.        
        out.append('</body></html>')

        self.response.out.write('\n'.join(out))


class Upload(webapp.RequestHandler):
    """Passes the uploaded file to Scribd and redirects back to the main page."""
    
    def post(self):
        # Get the cStringIO object containing the file data.
        file = self.request.POST.get('file').file
        
        # Get the name of the uploaded file.
        name = self.request.POST.get('file').filename
        
        # Upload the file to Scribd.
        scribd.api_user.upload(file, name, access='private')

        # Redirect back to the main page.
        self.redirect('/')


application = webapp.WSGIApplication([
        ('/', Form),
        ('/upload', Upload),
    ],
    debug=True)


if __name__ == '__main__':
    # Set the Scribd API key and API secret.
    scribd.config('<put_your_api_key_here>', '<put_your_api_secret_here>')
    
    # Start the application.
    run_wsgi_app(application)  
}}}